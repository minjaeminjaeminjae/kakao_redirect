<!DOCTYPE html>
<html>
  <head>
    <title>Redirecting to Kakao...</title>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-CXX7D36FTW"></script>
    <script>
      window.dataLayer = window.dataLayer || [];
      function gtag(){dataLayer.push(arguments);}
      gtag('js', new Date());
      gtag('config', 'G-CXX7D36FTW');
    </script>
  </head>
  <body>
    <p>SAT ì „ë¬¸ê°€ë¥¼ ë§Œë‚˜ëŸ¬ ê°€ëŠ” ì¤‘ì…ë‹ˆë‹¤...</p>
    <script>
      const params = new URLSearchParams(window.location.search);
      const src = params.get('src') || 'unknown';

      // 2. êµ¬ê¸€ ì•±ìŠ¤ ìŠ¤í¬ë¦½íŠ¸ ì£¼ì†Œ (ë³´ë‚´ì£¼ì‹  ì£¼ì†Œ ìœ ì§€)
      const GOOGLE_SCRIPT_URL = "https://script.google.com/macros/s/AKfycbxT5fH5Ty-J_VRpQPx62zgqR-NYZFCrxn9c_ocah8ppTJa8EF5tFCj1fBv43Hl1NLa5uw/exec";

      // 3. ì˜¤í”ˆì¹´í†¡ ë§í¬ ë§¤í•‘
      const kakaoLinks = {
        writerM: "https://open.kakao.com/o/sLyyN9Lg",
        writerB: "https://open.kakao.com/o/sjYJo9bh",
        writerW: "https://open.kakao.com/o/sxHGVZ4h",
        summer: "https://open.kakao.com/o/sbz0Wbqh",
        landing: "https://open.kakao.com/o/sdnqERAh",
        instagram: "https://open.kakao.com/o/snZ5FDzh",
        writerH: "https://open.kakao.com/o/sfYDn9bh"
      };

      let kakaoLink = "https://open.kakao.com/o/defaultLink";

      // srcì— ë”°ë¼ ë§í¬ ê²°ì •
      if (src.includes("writerM")) kakaoLink = kakaoLinks.writerM;
      else if (src.includes("writerB")) kakaoLink = kakaoLinks.writerB;
      else if (src.includes("summer")) kakaoLink = kakaoLinks.summer;
      else if (src.includes("landing")) kakaoLink = kakaoLinks.landing;
      else if (src.includes("instagram")) kakaoLink = kakaoLinks.instagram;   
      else if (src.includes("writerH")) kakaoLink = kakaoLinks.writerH;
      else if (src.includes("writerW")) kakaoLink = kakaoLinks.writerW;  

      // -----------------------------------------------------------
      // [ìµœì¢… ë³‘ê¸°] ë´‡/ì¤‘ë³µ ì°¨ë‹¨ í•„í„° ì ìš©
      // -----------------------------------------------------------
      function shouldSendAlert(src) {
        const ua = navigator.userAgent.toLowerCase();
        
        // 1. [ê¸°ë³¸ ì°¨ë‹¨] ë´‡ í‚¤ì›Œë“œ + Headless ê°ì§€
        if (/bot|crawler|spider|crawling|facebook|kakaotalk|twitter|slack|whatsapp|telegram|naver|headless|lighthouse|google-inspectiontool/.test(ua)) {
            console.log("ğŸš« Bot User-Agent detected.");
            return false;
        }

        // 2. [ê°•ë ¥ ì°¨ë‹¨] WebDriver(ìë™í™” ë„êµ¬) ê°ì§€
        if (navigator.webdriver) {
            console.log("ğŸš« WebDriver detected.");
            return false;
        }

        // 3. [ìœ ë ¹ ë¸Œë¼ìš°ì € ì°¨ë‹¨] ì¤‘ìš”! í™”ë©´ì´ ìˆ¨ê²¨ì§„ ìƒíƒœ(ë¯¸ë¦¬ë³´ê¸° ë´‡) ì°¨ë‹¨
        // ì¹´í†¡/ìŠ¬ë™ ë“±ì´ ë§í¬ ì´ë¯¸ì§€ë¥¼ ê¸ì–´ê°ˆ ë•Œ í™”ë©´ì„ ë„ìš°ì§€ ì•Šê³ (Hidden) ë“¤ì–´ì˜¤ëŠ” ê²ƒì„ ë§‰ìŠµë‹ˆë‹¤.
        if (!window.screen || window.screen.width === 0 || window.screen.height === 0 || document.visibilityState === 'hidden') {
            console.log("ğŸš« Hidden/Ghost browser detected.");
            return false;
        }

        // 4. [ì¤‘ë³µ ë°©ì§€] ê¸°ì–µë ¥(LocalStorage) ì²´í¬ (10ë¶„ ì¿¨íƒ€ì„)
        // ê°™ì€ ë¸Œë¼ìš°ì €ì—ì„œ 10ë¶„ ë‚´ì— ë‹¤ì‹œ í´ë¦­í•˜ë©´ ë¬´ì‹œí•©ë‹ˆë‹¤.
        const storageKey = 'slack_alert_kakao_' + src; 
        const lastSent = localStorage.getItem(storageKey);
        const now = new Date().getTime();

        if (lastSent && (now - lastSent < 600000)) { // 600,000ms = 10ë¶„
            console.log("ğŸš« Duplicate blocked (Sent within 10 mins).");
            return false;
        }

        // í†µê³¼ ì‹œ í˜„ì¬ ì‹œê°„ ê¸°ë¡
        localStorage.setItem(storageKey, now);
        return true;
      }

      // ê²€ì‚¬ ì‹¤í–‰ (Trueë©´ ì‚¬ëŒ, Falseë©´ ë´‡)
      const isRealUser = shouldSendAlert(src);

      // 4. GA ì´ë²¤íŠ¸ ì „ì†¡
      gtag('event', 'kakao_redirect', {
        event_category: 'BlogToKakao',
        event_label: src
      });

      // 5. ìŠ¬ë™ ì „ì†¡ (ì§„ì§œ ì‚¬ëŒì¼ ë•Œë§Œ)
      if (isRealUser) {
          // 0.5ì´ˆ ë”œë ˆì´ë¥¼ ì£¼ì–´ ìˆœê°„ ìŠ¤ìº” ë´‡ íšŒí”¼
          setTimeout(() => {
            fetch(GOOGLE_SCRIPT_URL, {
                method: "POST",
                mode: "no-cors", 
                headers: {
                "Content-Type": "application/json",
                },
                body: JSON.stringify({ 
                    src: src,
                    type: 'kakao' // êµ¬ê¸€ ìŠ¤í¬ë¦½íŠ¸ì—ì„œ ì¹´í†¡ì„ì„ ì¸ì‹
                }),
            }).catch(err => console.log("Slack Alert Error:", err));
          }, 500);
      } else {
          console.log("Slack alert skipped by filter.");
      }

      // 6. 3ì´ˆ í›„ ë¦¬ë””ë ‰ì…˜
      setTimeout(() => {
        window.location.href = kakaoLink;
      }, 3000); 
    </script>
  </body>
</html>
